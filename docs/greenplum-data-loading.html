<!--
Copyright (C) 2019-Present Pivotal Software, Inc. All rights reserved.
This program and the accompanying materials are made available under the terms of the under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License. You may obtain a copy of the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and
limitations under the License.
-->

<!DOCTYPE html>
<html class="sl-root decks export offline loaded">
<head>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>gp-data-loading</title>


    <link rel="stylesheet" type="text/css" href="lib/offline-v2.css">
    <link href="lib/gp-workshop.css" rel="stylesheet" type="text/css"/>
    <link href="lib/gp-workshop-grid.css" rel="stylesheet" type="text/css"/>

</head>
<body class="reveal-viewport theme-font-montserrat theme-color-white-blue">
<div class="reveal">
    <div class="slides">
        <section class="title-slide" data-id="title-slide">
            <div class="grid-page">
                <div class="full-page" id="title-slide">
                    <div><h1>Petabyte Scale Data Warehousing with Greenplum</h1></div>
                    <h2 class="subtitle">Data Loading</h2>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-2">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>Data Loading Methods</h2>
                        <h3>Traditional and Greenplum Specific</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="content-top-half" style="align-items: flex-end; margin-top: 30px;">
                    <div>
                        <img style="width: 70%" alt="loading-inserts" src="images/loading-insert.png">
                        <p class="add-bg">SQL INSERT</p>
                    </div>

                    <div>
                        <img style="width: 70%" alt="loading-copy" src="images/loading-copy.png">
                        <p class="add-bg">SQL COPY</p>
                    </div>

                    <div>
                        <img style="width: 70%" alt="loading-external-tables" src="images/loading-external-tables.png">
                        <p class="add-bg">External Tables</p>
                    </div>
                </div>
                <div class="content-bottom-half" style="align-items: flex-end; margin-top: 30px">
                    <div>
                        <img style="width: 70%" alt="loading-gpfdist-gpload" src="images/loading-gpfdist-gpload.png">
                        <p class="add-bg">gpfdist/gpload</p>
                    </div>
                    <div>
                        <img style="width: 70%" alt="loading-pxf" src="images/pxf-data-flow.png">
                        <p class="add-bg">PXF</p>
                    </div>
                    <div>
                        <img style="width: 70%;" alt="loading-gphdfs" src="images/loading-gphdfs.png">
                        <p style="background-color: darkgrey; color: grey">gphdfs</p>
                    </div>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-3">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>COPY Command</h2>
                        <h3>Data Loading</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="content-top-half">
                    <div style="margin-right: auto;">
                        <ul>
                            <li style="font-weight: bold; margin-left: -40px;" class="nobullet">SQL COPY command</li>
                            <li>PostgreSQL command</li>
                            <li>Loads all rows in one command and is not parallel</li>
                            <li>Loads data from a file or from standard input</li>
                            <li>Supports error handling similar to external tables</li>
                        </ul>
                    </div>
                </div>
                <div class="content-bottom-half" style="margin-right: auto">
                    <div class="sl-block-content notranslate" data-highlight-theme="sunburst" data-code-frame="none"
                         style="z-index: 16; font-size: 95%;">
                        <pre><code>COPY mytable FROM '/data/myfile.csv' WITH CSV HEADER;</code></pre>
                    </div>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-4">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>Loading from External Tables</h2>
                        <h3>Data Loading</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="full-page" style="margin-right: auto; ">
                    <ul>
                        <li style="font-weight: bold; margin-left: -40px;" class="nobullet">Read-only External Tables:</li>
                        <li>Access data outside the Greenplum database</li>
                        <li>Leverage parallel processing power of segments</li>
                        <li>Can be accessed with SELECT statements</li>
                        <li>Commonly used for ETL/ELT and data loading</li>
                    </ul>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-5">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>External Table Types</h2>
                        <h3>Data Sources and Protocols</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="content-left-half boxshadow">
                    <div class="side-by-side">
                        <img style="width: 70%" alt="files" src="images/delimited-files.png">
                        <div>
                            <ul style="font-size: 0.8em">
                                <li class="nobullet" style="font-weight: bold; margin-left: -2em;">File Sources</li>
                                <li>file://</li>
                                <li>gpfdist://</li>
                            </ul>
                        </div>
                        <img style="width: 70%" alt="websource" src="images/websource.png">
                        <div>
                            <ul style="font-size: 0.8em">
                                <li class="nobullet" style="font-weight: bold; margin-left: -2em;">Web Sources</li>
                                <li>http://</li>
                                <li>s3://</li>
                                <li>execute</li>
                            </ul>
                        </div>
                        <div class="justify-left">
                            <ul style="font-size: 0.8em;">
                                <li>HDFS</li>
                                <li>Hive</li>
                                <li>HBase</li>
                                <li>RDBMS</li>
                                <li>GRID</li>
                                <li>Custom</li>
                            </ul>
                        </div>
                        <div>
                            <ul style="font-size: 0.8em">
                                <li class="nobullet" style="font-weight: bold; margin-left: -2em;">All Sources</li>
                                <li>pxf://</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="content-right-half">
                    <div class="side-by-side">
                        <div class="stack-it">
                            <div class="side-by-side">
                                <p style="margin: 0px 10px;" >Load</p>
                                <img alt="line-arrow" src="images/icons/line-arrow.png">
                            </div>
                            <br>
                            <div class="side-by-side">
                                <img style="; transform: scaleX(-1)" alt="line-arrow" src="images/icons/line-arrow.png">
                                <p style="margin: 0px 10px">Unload</p>
                            </div>
                        </div>
                        <figure style="margin-bottom: 20px;">
                            <div class="position-text">
                                <p style="color: white; font-weight: bold; font-size: 1.2em; left: 50px; top: 20px;">Greenplum</p>
                            </div>
                            <img style="" alt="disk-pack-blue" src="images/disk-pack-blue.png">
                            <div class="position-text position-img side-by-side">
                                <p style="width: 8em; font-size: 80%; color: white; left: 5px; top: 100px;">Readable external table</p>
                                <img style="width: 30%; left: 200px; top:100px;" alt="customer-table-columns" src="images/customer-table.png">
                            </div>
                            <div class="position-text position-img side-by-side">
                                <p style="width: 8em; font-size: 80%; color: white; left: 5px; top: 200px;">Writeable external table</p>
                                <img style="width: 30%; left: 200px; top:200px;" alt="customer-table-columns" src="images/customer-table.png">
                            </div>
                        </figure>
                    </div>
                    <div class="boxshadow" style="padding: 5px 40px;">
                        <ul>
                            <li class="nobullet" style="font-weight: bold; margin-left: -2em;">Formats</li>
                            <li>Text, CSV</li>
                            <li>XML</li>
                            <li>Avro, Parquet</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-6">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>File-based External Tables</h2>
                        <h3>Data Loading</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="full-page">
                    <ul>
                        <li class="nobullet" style="margin-left: -40px; font-weight: bold; font-size: 1.2em;">
                            When creating file-based external tables:
                        </li>
                        <li>Specify up to as many URIs as you have segments in the LOCATION</li>
                        <li>Each URI points to an external data file or data source</li>
                        <li>URIs do not need to exist prior to defining the external table</li>
                        <li>The URI must exist when the data is queried</li>
                    </ul>
                    <div class="sl-block-content notranslate fragment current-visible" data-highlight-theme="github-gist" data-code-frame="none"
                         style="z-index: 13; font-size: 100%; border-style: solid; border-width: 4px;"
                         data-code-wrap="true">
                        <pre><code style="padding: 10px;">CREATE EXTERNAL TABLE ext_expenses (name text, ...)
LOCATION (
   'file://seghost1/data/external/expenses1.csv',
   'file://seghost1/data/external/expenses2.csv',
   'file://seghost2/data/external/expenses3.csv',
   'file://seghost2/data/external/expenses4.csv'
)
FORMAT 'CSV' ( HEADER );</code></pre>
                    </div>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-7">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>gpfdist and gpload</h2>
                        <h3>Parallel File Distribution Program</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="content-left-half">
                    <div class="boxshadow" style="background-color: rgba(0, 135, 116, 0.3); margin-top: 100px;">
                        <ul>
                            <li class="nobullet" style="margin-left: -40px; font-weight: bold">gpfdist</li>
                            <li>HTTP-based file server</li>
                            <li>Can be run on an external server</li>
                            <li>Distributes data at 200 MB/s per gpfdist</li>
                            <li>Provides full parallelism for best performance</li>
                        </ul>
                    </div>
                </div>
                <div class="content-right-half">
                    <div class="boxshadow" style="background-color: rgba(0, 135, 116, 0.3); margin-top: 100px;">
                        <ul>
                            <li class="nobullet" style="margin-left: -40px; font-weight: bold">gpload</li>
                            <li>Interfaces with and invokes gpfdist</li>
                            <li>Creates the external table definition</li>
                            <li>Executes INSERT, UPDATE, or MERGE to load data</li>
                            <li>Uses YAML config file</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-8">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>gpfdist example</h2>
                        <h3>Parallel File Distribution Program</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="full-page">
                    <div class="sl-block-content notranslate" data-highlight-theme="github-gist" data-code-frame="none"
                         style="z-index: 14; font-size: 75%; border-style: solid; border-width: 3px; margin-top: 20px;">
                    <pre><code>gpfdist -d /var/load_files/expenses1 -p 8081 &gt;&gt; gpfdist.log 2&gt;&amp;1 &amp;
gpfdist -d /var/load_files/expenses2 -p 8082 &gt;&gt; gpfdist.log 2&gt;&amp;1 &amp;</code></pre>
                    </div>
                    <div class="sl-block-content notranslate" data-highlight-theme="sunburst" data-code-frame="none"
                         style="z-index: 15; font-size: 85%; margin-top: 40px">
                    <pre>
<code>CREATE EXTERNAL TABLE ext_expenses
   (name text, date date,  amount float4, description text)
   LOCATION (
        'gpfdist://etlhost:8081/*',
        'gpfdist://etlhost:8082/*')
   FORMAT 'TEXT' (DELIMITER '|')
   ENCODING ’UTF-8’
   LOG ERRORS
   SEGMENT REJECT LIMIT 10000 ROWS ;
</code></pre>
                    </div>
                    <div class="sl-block-content notranslate" data-highlight-theme="obsidian" data-code-frame="none"
                         style="z-index: 16; font-size: 100%; margin-top: 40px">
                        <pre><code>INSERT INTO expenses (SELECT * FROM ext_expenses);</code></pre>
                    </div>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-9">
            <aside class="notes">
                In this example, the YAML control file, load_faadata.yaml, defines how data from several source files is
                to be loaded into the faa2 database.
                It is assumed that the faadata.factontimeperformance and public.audit tables already exist within the database.
                A reject limit of 100 errors is defined for this load, with any errors redirected to the
                faadata.faadataerr table.<br>
                Before the load occurs, the table is truncated. The external table created as a result of this load will
                not be reused.
                Reusing a table is useful if you are performing trickle loads or need to reduce system catalog bloat,
                which can occur when creating and dropping
                multiple temporary tables. By reusing the table, the table is not destroyed and recreated.
            </aside>
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>gpload</h2>
                        <h3>Control File Example - yaml</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="content-first-third" style="font-size: 80%;">
                    <p style="">
                        Greenplum connection information
                    </p>
                    <p style="margin-top: 100px;">
                        gpfdist config info
                    </p>
                    <p style="margin-top: 110px;">
                        Pre-existing table, data entry mode
                    </p>
                    <p style="margin-top: 50px;">
                        Pre and post SQL
                    </p>
                </div>
                <div class="content-two-third">
                    <div class="sl-block-content notranslate" data-highlight-theme="github-gist" data-code-frame="none"
                         style="padding: 3px; font-size: 50%; border-style: solid; border-width: 2px;"><pre><code>VERSION: 1.0.0.1
DATABASE: faa2
USER: gpadmin
HOST: smdw
PORT: 5432
GPLOAD:
  INPUT:
    - SOURCE:
        LOCAL_HOSTNAME:
            - mdw
        PORT: 8081
        FILE:
            - /rawdata/FAAData/On_Time_On_Time_Performance_*.csv
    - FORMAT: csv
    - DELIMITER: ','
    - ESCAPE: '"'
    - QUOTE: '"'
    - HEADER: true
    - ERROR_LIMIT: 100
  OUTPUT:
    - TABLE: faadata.factontimeperformance
    - MODE: insert
  PRELOAD:
    - TRUNCATE: true
    - REUSE_TABLES: false
  SQL:
    - BEFORE: "INSERT INTO audit VALUES('start', current_timestamp)"
    - AFTER: "INSERT INTO audit VALUES('end', current_timestamp)"</code></pre>
                    </div>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-10">
            <aside class="notes">
                The gpload utility is executed with the following syntax:<br>
                gpload –f control_name<br>
                The command will display the gpfdist command that was issued.<br>
                Once the external table has been created, data is automatically loaded into the target database table
                specified in the control file.<br>
                gpload display the number of rows inserted, updated, as well as the number of errors
                encountered.<br><br>
                If the user is not specified on the command line, with the “-U” option, gpload will extract the user
                from one of the following in the order shown:
                the load control file, the environment variable $PGUSER or the login of the user running the
                command.<br>
                As with the user, if the password is not specified on the command line, gpload will extract the password
                from the following in the order specified:
                $PGPASSWORD variable, the password file specified by $PGPASSFILE or ~/.pgpass; if none of these contain
                the password, you will be prompted.<br>
                Once the control file has been created, issuing the gpload command starts a chain of events:<br>
                - The gpfdist program is started.<br>
                - gpload creates the external table based on the YAML file.<br>
                - The data is loaded using INSERT, as specified in the YAML file.
            </aside>
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>gpload Invocation Syntax</h2>
                        <h3>Syntax and example invocation output</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="full-page">
                    <div class="sl-block-content notranslate" data-highlight-theme="sunburst" data-code-frame="none"
                         style="z-index: 14; font-size: 100%;"><pre><code>gpload -f control_file
    [-l &lt;log file&gt;]
    [-h &lt;hostname&gt;]  [-p &lt;port&gt;]
    [-U &lt;username&gt;]  [-d &lt;database&gt;]
    [-W] [-v | -V] [-q] [-D]

gpload -? | --version</code></pre>
                    </div>
                    <div class="sl-block-content notranslate" data-highlight-theme="obsidian" data-code-frame="none"
                         style="z-index: 15; font-size: 70%;" data-code-wrap="true"><pre><code>$ gpload -f load_faadata.yaml
2012-01-17 09:05:29|INFO|gpload session started 2012-01-17 09:05:29
2012-01-17 09:05:29|INFO|started gpfdist -p 8081 -P 8082 -f "/rawdata/FAADOn_Time_Performance_*.csv" -t 30
2012-01-17 09:11:23|INFO|running time: 353.36 seconds
2012-01-17 09:11:23|INFO|rows Inserted          = 20860045
2012-01-17 09:11:23|INFO|rows Updated           = 0
2012-01-17 09:11:23|INFO|data formatting errors = 0
2012-01-17 09:11:23|INFO|gpload succeeded
$</code></pre>
                    </div>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slides-11-thru-14">

            <section data-id="data-loading-slide-11">
                <aside class="notes">
                    In the first example shown on the slide, an external web table is defined using the HTTP protocol.
                    Three different URLs are associated with the external table, all using the CSV format.<br><br>
                    The second example shows how to define an external table to a script. The script:<br>
                    - Must be located on all segments in the same location.<br>
                    - Must be executable by the superuser account.<br>
                    - Will execute by one segment on each segment host.<br>
                    - Executes in parallel on all segments.<br><br>
                    In the third example, the external table is created on the command, df -k.
                    The command is executed by each primary segment.
                </aside>
                <div class="grid-page">
                    <div class="header">
                        <div>
                            <h2>External Web Table</h2>
                            <h3>Protocol and Format</h3>
                        </div>
                        <div class="logo-image"><img alt="" src=""></div>
                    </div>
                    <div class="full-page">
                        <div class="side-by-side">
                            <p style="z-index: 15; margin-right: 10px;">Loading from a set of URLs</p>
                            <div class="sl-block-content notranslate" data-highlight-theme="sunburst" data-code-frame="none"
                                 style="z-index: 15; font-size: 65%;">
                        <pre><code>CREATE EXTERNAL WEB TABLE ext_expenses (name text,
    exp_date date, amount float4, desc text)
LOCATION (
'http://xyz.company.com/expenses/sales/expenses.csv',
'http://xyz.company.com/expenses/finance/expenses.csv',
'http://xyz.company.com/expenses/ops/expenses.csv'
) FORMAT 'CSV' ( HEADER );</code></pre>
                            </div>
                            <p style="z-index: 17; margin-right: 15px;">Loading from a script</p>
                            <div class="sl-block-content notranslate" data-highlight-theme="solarized-light"
                                 data-code-frame="none"
                                 style="z-index: 17; font-size: 65%;" data-code-wrap="true">
                            <pre><code>CREATE EXTERNAL WEB TABLE log_output (linenum int,
       message text)
EXECUTE '/var/load_scripts/get_log_data.sh'
ON HOST FORMAT 'TEXT' (DELIMITER '|');</code></pre>
                            </div>
                            <p style="z-index: 19; margin-right: 10px;">Loading from a command</p>
                            <div class="sl-block-content notranslate" data-highlight-theme="sunburst" data-code-frame="none"
                                 style="z-index: 19; font-size: 80%;" data-code-wrap="true"><pre><code>CREATE EXTERNAL WEB TABLE du_space (
      storage text
)
EXECUTE 'df -k' ON ALL FORMAT 'TEXT';</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section data-id="data-loading-slide-12">
                <aside class="notes">
                    When an external table command is executed, that command is executed from within the database and
                    not from a login shell. If you rely on environment variables in external web table commands, such
                    as the $PATH variable, keep in mind that the .bashrc or .profile of the current user will not be
                    sourced at the segment host. You can set desired environment variables from within the EXECUTE
                    clause of your external web table definition as follows:<br>
                    CREATE EXTERNAL WEB TABLE ext_table (…) EXECUTE 'export PATH=/usr/sbin‘<br><br>
                    Note that you can disable the use of the EXECUTE command in web table definitions by setting the
                    parameter, gp_external_enable_exec, to off in the postgresql.conf file.
                </aside>
                <div class="grid-page">
                    <div class="header">
                        <div>
                            <h2>External Web Table</h2>
                            <h3>Environment variables</h3>
                        </div>
                        <div class="logo-image"><img alt="" src=""></div>
                    </div>
                    <div class="full-page">
                        <div>
                            <p style="text-align: left;padding: 0px 10px; background-color: rgb(217, 234, 211);">
                                Environment variables are not source'd at the segment host. They can be
                                set in the EXECUTE clause as follows:</p>
                            <div class="sl-block-content notranslate" data-highlight-theme="sunburst" data-code-frame="none"
                                 style="z-index: 13; font-size: 85%; padding: 10px 0px; margin-top: -25px">
                                <pre><code>CREATE EXTERNAL WEB TABLE TEST(segname text, abbrev text)
  EXECUTE 'export HNAME="$HOSTNAME"-SR; echo
  "$HOSTNAME,$HNAME"' FORMAT 'TEXT' (DELIMITER ',');

SELECT * FROM test;
 segname | abbrev
---------+---------
 sdw2    | sdw2-SR
 sdw1    | sdw1-SR
(2 rows)</code></pre>
                            </div>
                            <p style="background-color: var(--pivotal-green); color: white; font-size: 95%; margin-top: 20px;">
                                To disable the use of the EXECUTE command in web table definitions
                            </p>
                            <div class="sl-block-content notranslate" data-highlight-theme="github-gist" data-code-frame="none"
                                 style="z-index: 19; font-size: 100%; border-style: solid; border-width: 1px; margin-top: -7px;">
                                <pre class="none"><code>gpadmin$ gpconfig -c gp_external_enable_exec -v off</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section data-id="data-loading-slide-13">
                <aside class="notes">
                    The Greenplum Database variables shown in the table are available to operating system commands
                    executed by an external table.
                    These variables are set as environment variables in the shell that executes the external table
                    command(s).
                    They can be used to identify a set of requests made by an external table statement, at runtime,
                    across the Greenplum Database
                    array of hosts and segment instances.
                </aside>
                <div class="grid-page">
                    <div class="header">
                        <div>
                            <h2>External TABLE Environment Variables</h2>
                        </div>
                        <div class="logo-image"><img alt="" src=""></div>
                    </div>
                    <div class="full-page" style="font-size: 90%">
                        <table>
                            <tbody>
                            <tr>
                                <th>Variable</th>
                                <th>Description</th>
                            </tr>
                            <tr>
                                <td>$GP_ID</td>
                                <td>Command count of the session executing the external table statement.</td>
                            </tr>
                            <tr>
                                <td>$GP_DATABASE</td>
                                <td>Database that the external table definition resides in.</td>
                            </tr>
                            <tr>
                                <td>$GP_DATE</td>
                                <td>Date the external table command was executed.</td>
                            </tr>
                            <tr>
                                <td>$GP_MASTER_HOST</td>
                                <td>Host name of the GP master from which the external table statement was dispatched.
                                </td>
                            </tr>
                            <tr>
                                <td>$GP_MASTER_PORT</td>
                                <td>Port number of the GP master from which the external table statement was dispatched.
                                </td>
                            </tr>
                            <tr>
                                <td>$GP_SEG_DATADIR</td>
                                <td>Data directory location of the segment instance executing the external table
                                    command.
                                </td>
                            </tr>
                            <tr>
                                <td>$GP_SEG_PG_CONF</td>
                                <td>Location of the <em>postgresql.conf</em> file for the segment.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            <section data-id="data-loading-slide-14">
                <div class="grid-page">
                    <div class="header">
                        <div>
                            <h2>External TABLE Environment Variables (cont.)</h2>
                        </div>
                        <div class="logo-image"><img alt="" src=""></div>
                    </div>
                    <div class="full-page" style="font-size: 90%">
                        <table>
                            <tbody>
                            <tr>
                                <th>Variable</th>
                                <th>Description</th>
                            </tr>
                            <tr>
                                <td>$GP_SEG_PORT</td>
                                <td>Port number of the segment instance executing command.</td>
                            </tr>
                            <tr>
                                <td>$GP_SEGMENT_COUNT</td>
                                <td>Total number of primary segments in the GP cluster.</td>
                            </tr>
                            <tr>
                                <td>$GP_SEGMENT_ID</td>
                                <td>ID of the segment instance executing command.</td>
                            </tr>
                            <tr>
                                <td>$GP_SESSION_ID</td>
                                <td>Database session identifier number associated with command.</td>
                            </tr>
                            <tr>
                                <td>$GP_SN</td>
                                <td>Serial number of the external table scan node in the query plan of the external
                                    table
                                    statement.
                                </td>
                            </tr>
                            <tr>
                                <td>$GP_TIME</td>
                                <td>Time the external table command run.</td>
                            </tr>
                            <tr>
                                <td>$GP_USER</td>
                                <td>Database user running the command.</td>
                            </tr>
                            <tr>
                                <td>$GP_XID</td>
                                <td>Transaction ID of the external table statement.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </section>
        <section data-id="data-loading-slide-15">
            <aside class="notes">
                The most common use of external tables is to facilitate loading of data. This is typically done by issuing a
                CREATE TABLE AS SELECT or INSERT INTO SELECT command, where the SELECT statement triggers the flow of data.
                <br>
                By default, if the external table data contains an error, the entire command fails and no data is loaded into the
                target table. To isolate data errors in external table data while still loading correctly formatted rows,
                you define an external table with a SEGMENT REJECT LIMIT clause.
                <br><br>
                Specify the number of error rows acceptable, on a per-segment basis, after which the entire external table operation
                will be aborted and no rows will be processed or loaded.
                <br><br>
                Note that the count of error rows is per-segment, not per entire operation. The following conditions then apply:
                <br>
                If the per-segment reject limit is not reached, all rows that do not contain an error will be processed.
                <br>
                If the limit is not reached, all good rows will be processed and any error rows discarded or logged.
                <br>
                If you would like to keep error rows for further examination, include the LOG ERRORS clause.
                Any rows containing a format error would then be logged to an internal Greenplum table. To view the bad rows captured,
                use the gp_read_error_log('\u003cdb_table\u003e') function:
                <br><br>
                select * from gp_read_error_log ('table name');
            </aside>
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>External Table Error Handling</h2>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="full-page">
                    <ul>
                        <li> Incorrectly formatted rows are rejected:
                            <ul>
                                <li> Missing or extra attributes</li>
                                <li> Columns of the wrong data type</li>
                                <li> Invalid client encoding sequence</li>
                            </ul>
                        </li>
                        <li> CONSTRAINT errors (NOT NULL, CHECK, UNIQUE) are handled as "all or nothing" - not single row isolation</li>
                        <li> Format of error handling clause:<br>
                            <pre><span style="font-size:90%">[LOG ERRORS] SEGMENT REJECT LIMIT count [ROWS | PERCENT]</span></pre>
                        </li>
                    </ul>
                    <div class="sl-block-content notranslate" data-highlight-theme="obsidian" data-code-frame="none"
                         style="z-index: 17; font-size: 105%;">
                    <pre><code>-- To view bad/rejected rows
SELECT  *  FROM gp_read_error_log ('table_name');</code></pre>
                    </div>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-16">
            <aside class="notes">
                Query planning of complex queries involving external tables is not optimal because:<br>
                There are no statistics to help the query planner choose a good plan.<br>
                The data is not in the database.<br>
                External tables are really not meant to be used in frequent, ad-hoc queries.
            </aside>
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>External Table Planner Statistics</h2>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="full-page">
                    <ul>
                        <li class="nobullet" style="margin: 80px 0px 0px -40px; font-size: 110%">
                            Query planning of complex queries on external tables is not optimal
                        </li>
                        <li>
                            Data resides outside the database
                        </li>
                        <li>
                            Statistics are not captured for external table data
                        </li>
                        <li>
                            Data from external tables are not meant for frequent or ad-hoc access
                        </li>
                    </ul>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-17">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>Performance Tips</h2>
                        <h3>Data loading</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="full-page">
                    <ul style="margin-top: 80px;">
                        <li>Drop indexes before loading and recreate after the load</li>
                        <li>Use gpfdist to load and unload large amounts of data</li>
                        <li>Spread the data evenly across as many ETL nodes as possible</li>
                        <li>Split very large data files into equal parts and spread the data across as many file systems as possible</li>
                        <li>Run two gpfdist instances per file system</li>
                        <li>Run gpfdist on as many network interfaces as possible</li>
                    </ul>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-18">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>Performance Tips (cont.)</h2>
                        <h3>Data loading</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="full-page">
                    <ul style="margin-top: 80px;">
                        <li><em>gp_external_max_segs</em></li>
                        <ul>

                            <li>Use to control the number of segments each gpfdist serves</li>
                            <li>Keep an even factor with the number of gpfdist processes</li>
                        </ul>
                        <li> Always drop indexes before loading into existing tables and re-create the index after loading</li>
                        <li> Always run ANALYZE on the table after loading it</li>
                        <li> Disable automatic statistics collection during loading by setting <em>gp_autostats_mode</em> to NONE</li>
                        <li> Run VACUUM after load errors to recover space</li>
                    </ul>
                </div>
            </div>
        </section>
        <section data-background-color=var(--pivotal-green) data-menu-title="Appendix">
            <div class="grid-page">
                <div class="full-page">
                    <h1 style="font-size: 300%; font-weight: bold; color: yellow; margin-top: 100px;">Appendix</h1>
                </div>
            </div>
        </section>

        <section data-id="data-loading-slide-19">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>gphdfs example</h2>
                        <h3>Accessing Hadoop data</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="full-page">
                    <div>
                        <div class="sl-block-content notranslate" data-highlight-theme="sunburst" data-code-frame="none"
                             style="z-index: 14; font-size: 70%;">
                    <pre>
<code>DROP EXTERNAL TABLE IF EXISTS wiki_pages_ext;

CREATE EXTERNAL TABLE wiki_pages_ext ( LIKE wiki_pages )
LOCATION ('gphdfs://hadoop-w-0:8020/user/gpadmin/word_count/out/part-m-*')
FORMAT 'TEXT' (DELIMITER E'\t' NULL E'')
ENCODING 'UTF8'
LOG ERRORS SEGMENT REJECT LIMIT 1 PERCENT;

GRANT SELECT ON wiki_pages_ext TO demo;
</code>
                    </pre>
                        </div>
                        <div class="sl-block-content notranslate"
                             data-highlight-theme="obsidian" data-code-frame="none"
                             style="z-index: 15; font-size: 70%;">
                    <pre>
<code>INSERT INTO wiki_pages SELECT * FROM wiki_pages_ext;
NOTICE: Found 66 data formatting errors (66 or more input rows)
INSERT 0 15347677
Time: 9674.557 ms

SELECT COUNT(*) FROM wiki_pages;
  count
---------
15347677
(1 row)
</code>
                    </pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section data-id="data-loading-slide-20">
            <div class="grid-page">
                <div class="header">
                    <div>
                        <h2>gphdfs config parameters</h2>
                        <h3>Accessing Hadoop data</h3>
                    </div>
                    <div class="logo-image"><img alt="" src=""></div>
                </div>
                <div class="full-page">
                    <p style="text-align: left;">One time setup for using gphdfs requires setting a couple of parameters </p>
                    <ul>
                        <li>
                            <pre style="color: var(--pivotal-green)">gp_hadoop_target_version</pre>
                            <ul>
                                <li>​corresponds with the version of Hadoop being accessed</li>
                            </ul>
                        </li>
                        <li>
                            <pre style="color:var(--pivotal-green)">gp_hadoop_home</pre>
                            <ul>
                                <li>directory containing Hadoop client libraries</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </section>
        <section data-background-color=var(--pivotal-green)
                 class="last-slide" data-menu-title="End">
            <div class="grid-page">
                <div class="full-page">
                    <img alt="Greenplum Database" data-src="images/logos/logo-gp-horizontal-ondark.png">
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    var SLConfig = {
        "deck": {
            "id": 1619774,
            "slug": "greenplum-data-loading",
            "title": "gp-data-loading",
            "description": "Greenplum Database techniques for loading data",
            "width": 960,
            "height": 720,
            "visibility": "self",
            "published_at": null,
            "sanitize_messages": null,
            "thumbnail_url": "https://s3.amazonaws.com/media-p.slid.es/thumbnails/60e6798a0ade35541fdee9536be379d0/thumb.jpg?1570823271",
            "view_count": 0,
            "user": {
                "id": 1134143,
                "username": "csylvester",
                "name": "Craig Sylvester",
                "description": "Pivotal Data Engineer - Federal Division",
                "thumbnail_url": "https://www.gravatar.com/avatar/d2436491e8c9292c895eebad673e3837?s=140\u0026d=https%3A%2F%2Fstatic.slid.es%2Fimages%2Fdefault-profile-picture.png",
                "paid": true,
                "pro": true,
                "lite": false,
                "team_id": null,
                "settings": {
                    "id": 3868303,
                    "present_controls": true,
                    "present_upsizing": true,
                    "present_pointer": false,
                    "present_notes": true,
                    "default_deck_tag_id": null
                }
            },
            "background_transition": "slide",
            "transition": "slide",
            "theme_id": null,
            "theme_font": "montserrat",
            "theme_color": "white-blue",
            "auto_slide_interval": 0,
            "comments_enabled": true,
            "forking_enabled": false,
            "rolling_links": false,
            "center": false,
            "shuffle": false,
            "should_loop": false,
            "share_notes": false,
            "slide_number": false,
            "slide_count": 22,
            "rtl": false,
            "version": 2,
            "collaborative": null,
            "deck_user_editor_limit": 3,
            "data_updated_at": 1570825838363,
            "font_typekit": null,
            "font_google": null,
            "time_limit": null,
            "upsizing_enabled": true
        }
    };


    // Use local fonts
    SLConfig.fonts_url = 'lib/fonts/';
</script>

<script src="lib/reveal.min.js"></script>
<script src="lib/offline.js"></script>

<!-- Initialize the presentation -->
<script>
    Reveal.initialize({
        width: 960,
        height: 720,
        margin: 0.05,

        hash: true,
        controls: true,
        progress: true,
        mouseWheel: false,
        showNotes: false,
        slideNumber: false,

        autoSlide: 0,
        autoSlideStoppable: true,

        center: false,
        shuffle: false,
        loop: false,
        rtl: false,

        transition: "slide",
        backgroundTransition: "slide",

        highlight: {
            escapeHTML: false
        },

        /* Added menu plugin from https://github.com/denehyg/reveal.js-menu: CJS, 11oct2019 */
        /* For a description of the 'menu' options, see the gp-intro-overview.html presentation */
        menu: {
            side: 'left',
            width: 'wide',
            numbers: true,
            titleSelector: 'h1, h2, h3, h4, h5, h6',
            useTextContentForMissingTitles: false,
            hideMissingTitles: false,
            markers: true,
            custom: false,
            themes: false,
            themesPath: 'css/theme/',
            transitions: false,
            openButton: true,
            openSlideNumber: false,
            keyboard: true,
            sticky: false,
            autoOpen: true,
            delayInit: false,
            openOnInit: false,
            loadIcons: true
        },

        dependencies: [
            {
                src: 'lib/reveal-plugins/markdown/marked.js', condition: function () {
                    return !!document.querySelector('[data-markdown]');
                }
            },
            {
                src: 'lib/reveal-plugins/markdown/markdown.js', condition: function () {
                    return !!document.querySelector('[data-markdown]');
                }
            },
            {src: 'lib/reveal-plugins/highlight/highlight.js'},
            {
                src: 'lib/reveal-plugins/notes/notes.js', async: true, condition: function () {
                    return !!document.body.classList;
                }
            },
            {src: 'lib/reveal-plugins/zoom/zoom.js', async: true},
            {src: 'lib/reveal-plugins/menu/menu.js', async: false}

        ]
    });
</script>


</body>
</html>
